- name: Install dependencies
  become: true
  ansible.builtin.apt:
    name:
      - curl
      - ca-certificates
    state: present
    update_cache: true

- name: Install Ollama
  become: true
  ansible.builtin.shell: curl -sSL https://ollama.com/install.sh | sh
  args:
    creates: /usr/local/bin/ollama

# Empfehlung: Host/Port über Environment setzen (statt CLI-Flags),
# weil ich die Flags nicht verifizieren kann.
- name: Configure Ollama systemd service
  become: true
  ansible.builtin.copy:
    dest: /etc/systemd/system/ollama.service
    mode: "0644"
    content: |
      [Unit]
      Description=Ollama Service
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=simple
      Environment=OLLAMA_HOST={{ ollama_host | default('127.0.0.1') }}:{{ ollama_port | default(11434) }}
      ExecStart=/usr/local/bin/ollama serve
      Restart=always
      RestartSec=2
      DynamicUser=yes

      [Install]
      WantedBy=multi-user.target
  register: ollama_unit

- name: Reload systemd and restart Ollama when unit file changes
  become: true
  ansible.builtin.systemd:
    name: ollama
    state: restarted
    enabled: true
    daemon_reload: true
  when: ollama_unit is changed
- name: Ensure Ollama service is enabled and started
  become: true
  ansible.builtin.systemd:
    name: ollama
    state: started
    enabled: true

- name: Wait for Ollama API port
  ansible.builtin.wait_for:
    host: "{{ ollama_client_host | default(ollama_host | default('127.0.0.1')) }}"
    port: "{{ ollama_port | default(11434) }}"
    timeout: 60

- name: Pull models
  become: true
  ansible.builtin.command: /usr/local/bin/ollama pull {{ item }}
  loop: "{{ ollama_models }}"
  environment:
    # Some setups require "http://", others only "host:port" – cannot be verified here
    OLLAMA_HOST: "{{ ollama_client_host | default(ollama_host | default('127.0.0.1')) }}:{{ ollama_port | default(11434) }}"
  register: pull_models_result
  retries: 3
  delay: 5
  until: pull_models_result is succeeded