- name: Install dependencies
  become: true
  ansible.builtin.apt:
    name:
      - ca-certificates
    state: present
    update_cache: true

- name: Download Ollama installer
  become: true
  ansible.builtin.get_url:
    url: https://ollama.com/install.sh
    dest: /tmp/ollama-install.sh
    mode: "0755"

- name: Install Ollama
  become: true
  ansible.builtin.command: /bin/sh /tmp/ollama-install.sh
  args:
    creates: /usr/local/bin/ollama

- name: Ensure ollama group exists
  become: true
  ansible.builtin.group:
    name: ollama
    system: true
    state: present

- name: Ensure ollama user exists
  become: true
  ansible.builtin.user:
    name: ollama
    group: ollama
    system: true
    create_home: true
    home: /var/lib/ollama
    shell: /usr/sbin/nologin
    state: present

- name: Configure Ollama systemd service
  become: true
  vars:
    ai_ollama_bind_address: "{{ (ai_ollama_host | default('127.0.0.1')) ~ ':' ~ (ai_ollama_port | default(11434)) }}"
  ansible.builtin.template:
    src: ollama.systemd.j2
    dest: /etc/systemd/system/ollama.service
    mode: "0644"
  notify: Restart Ollama

- name: Ensure Ollama service is enabled and started
  become: true
  ansible.builtin.systemd:
    name: ollama
    state: started
    enabled: true
    daemon_reload: true

- name: Apply Ollama service changes immediately
  ansible.builtin.meta: flush_handlers

- name: Wait for Ollama API port
  vars:
    ai_ollama_api_host: >-
      {{ ai_ollama_client_host |
      default(ai_ollama_host | default('127.0.0.1')) }}
  ansible.builtin.wait_for:
    host: "{{ ai_ollama_api_host }}"
    port: "{{ ai_ollama_port | default(11434) }}"
    timeout: 60

- name: Pull models
  become: true
  vars:
    ai_ollama_api_endpoint: "{{ (ai_ollama_client_host | default(ai_ollama_host | default('127.0.0.1'))) ~ ':' ~ (ai_ollama_port | default(11434)) }}"
  ansible.builtin.command: ollama pull {{ item }}
  loop: "{{ ai_ollama_models }}"
  environment:
    OLLAMA_HOST: "{{ ai_ollama_api_endpoint }}"
  register: ai_pull_models_result
  changed_when: false
  retries: 3
  delay: 5
  until: ai_pull_models_result is succeeded
