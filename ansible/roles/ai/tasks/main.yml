- name: Install dependencies
  become: true
  ansible.builtin.apt:
    name:
      - ca-certificates
    state: present
    update_cache: true

- name: Download Ollama installer
  become: true
  ansible.builtin.get_url:
    url: https://ollama.com/install.sh
    dest: /tmp/ollama-install.sh
    mode: "0755"

- name: Install Ollama
  become: true
  ansible.builtin.command: /bin/sh /tmp/ollama-install.sh
  args:
    creates: /usr/local/bin/ollama

- name: Configure Ollama systemd service
  become: true
  vars:
    ai_ollama_bind_address: >-
      {{ ai_ollama_host | default('127.0.0.1') }}
      :{{ ai_ollama_port | default(11434) }}
  ansible.builtin.copy:
    dest: /etc/systemd/system/ollama.service
    mode: "0644"
    content: |
      [Unit]
      Description=Ollama Service
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=simple
      Environment=OLLAMA_HOST={{ ai_ollama_bind_address }}
      ExecStart=/usr/local/bin/ollama serve
      Restart=always
      RestartSec=2
      DynamicUser=yes

      [Install]
      WantedBy=multi-user.target
  notify: Restart Ollama

- name: Ensure Ollama service is enabled and started
  become: true
  ansible.builtin.systemd:
    name: ollama
    state: started
    enabled: true

- name: Wait for Ollama API port
  vars:
    ai_ollama_api_host: >-
      {{ ai_ollama_client_host |
      default(ai_ollama_host | default('127.0.0.1')) }}
  ansible.builtin.wait_for:
    host: "{{ ai_ollama_api_host }}"
    port: "{{ ai_ollama_port | default(11434) }}"
    timeout: 60

- name: Pull models
  become: true
  vars:
    ai_ollama_api_endpoint: >-
      {{ ai_ollama_client_host |
      default(ai_ollama_host | default('127.0.0.1')) }}
      :{{ ai_ollama_port | default(11434) }}
  ansible.builtin.command: /usr/local/bin/ollama pull {{ item }}
  loop: "{{ ai_ollama_models }}"
  environment:
    OLLAMA_HOST: "{{ ai_ollama_api_endpoint }}"
  register: ai_pull_models_result
  changed_when: false
  retries: 3
  delay: 5
  until: ai_pull_models_result is succeeded
