---
- name: 1. Install Dependencies
  apt:
    name: ["docker.io", "docker-compose-v2"]
    state: present
    update_cache: yes

- name: 2. Create Nextcloud Directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /opt/nextcloud
    - /var/lib/nextcloud/certs
    - /var/lib/nextcloud/ca-certificates

- name: 2b. Set Nextcloud Certificate Directory Permissions
  file:
    path: "{{ item }}"
    state: directory
    owner: "33"
    group: "33"
    mode: '0755'
  loop:
    - /var/lib/nextcloud/certs
    - /var/lib/nextcloud/ca-certificates

# ---------------------------------------------------------
# STEP-CA INTEGRATION PLACEHOLDER
# ---------------------------------------------------------
# Future Step-CA integration should drop the certificates here:
# /var/lib/nextcloud/certs/tls.crt
# /var/lib/nextcloud/certs/tls.key
# And the Root CA certificate here:
# /var/lib/nextcloud/ca-certificates/step-ca.crt
# With permissions matching the directory (owner/group 33 for Nextcloud)
# ---------------------------------------------------------

- name: 3. Copy Docker Compose to VM
  template:
    src: docker-compose.yml.j2
    dest: /opt/nextcloud/docker-compose.yml
    mode: '0644'

- name: 4. Run Nextcloud Stack
  shell: "docker compose -f /opt/nextcloud/docker-compose.yml up -d"

- name: 5. Wait for Nextcloud container to be ready
  pause:
    seconds: 20

- name: 6. Check if Nextcloud is already installed
  shell: "docker exec -u 33 nextcloud-app php occ status --output=json"
  register: nc_status
  ignore_errors: yes
  changed_when: false

- name: 7. Run Nextcloud basic installation
  shell: |
    docker exec -u 33 nextcloud-app php occ maintenance:install \
      --database "mysql" --database-name "nextcloud" \
      --database-user "nextcloud" --database-pass "{{ vault_nextcloud_db_password }}" \
      --database-host "db" \
      --admin-user "admin" --admin-pass "{{ vault_nextcloud_admin_password }}"
  when: (nc_status.stdout | default('{"installed":false}') | from_json).installed == false

- name: 8. Install and Enable Nextcloud Talk (spreed)
  shell: |
    docker exec -u 33 nextcloud-app php occ app:install spreed
  register: spreed_install
  failed_when: 
    - spreed_install.rc != 0
    - '"already installed" not in spreed_install.stdout'
  changed_when: '"already installed" not in spreed_install.stdout'

- name: 9. Generate Self-Signed SSL Certificate
  shell: |
    docker exec -u 0 nextcloud-app openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
      -keyout /etc/ssl/private/ssl-cert-snakeoil.key \
      -out /etc/ssl/certs/ssl-cert-snakeoil.pem \
      -subj "/C=SE/ST=Stockholm/L=Stockholm/O=ACME/OU=IT/CN=nextcloud.acme"
  ignore_errors: yes

- name: 10. Hardcode ACME Trusted Domains
  shell: |
    docker exec -u 33 nextcloud-app php occ config:system:set trusted_domains 0 --value="localhost"
    docker exec -u 33 nextcloud-app php occ config:system:set trusted_domains 1 --value="nextcloud.acme"
    docker exec -u 33 nextcloud-app php occ config:system:set trusted_domains 2 --value="10.0.50.20"
    docker exec -u 33 nextcloud-app php occ config:system:set trusted_domains 3 --value="192.168.88.20"
    docker exec -u 33 nextcloud-app php occ config:system:set overwriteprotocol --value="https"
    docker exec -u 33 nextcloud-app php occ config:system:delete overwritehost
  ignore_errors: yes

- name: 11. Install and Enable OIDC App
  shell: |
    docker exec -u 33 nextcloud-app php occ app:install user_oidc
    docker exec -u 33 nextcloud-app php occ app:enable user_oidc
  register: oidc_install
  failed_when: 
    - oidc_install.rc != 0
    - '"already installed" not in oidc_install.stdout'
  changed_when: '"already installed" not in oidc_install.stdout'

- name: 12. Final OIDC Configuration
  shell: |
    docker exec -u 33 nextcloud-app php occ config:system:set allow_local_remote_servers --value=true --type=boolean
    docker exec -u 33 nextcloud-app php occ user_oidc:provider "Keycloak" \
      --clientid "nextcloud-client" \
      --clientsecret "{{ vault_nextcloud_oidc_secret }}" \
      --discoveryuri "https://auth.server.acme:8443/realms/acme-realm/.well-known/openid-configuration" \
      --scope "openid profile email"
    docker exec -u 33 nextcloud-app php occ config:app:set user_oidc verify_host --value=0
    docker exec -u 33 nextcloud-app php occ config:app:set user_oidc verify_peer --value=0
    docker exec -u 33 nextcloud-app php occ config:system:set oidc_login_auto_redirect --value=true --type=boolean
    docker exec -u 33 nextcloud-app php occ config:app:set user_oidc allow_multiple_user_backends --value=0
    docker exec -u 33 nextcloud-app php occ config:app:set user_oidc soft_auto_provision --value=1
    docker exec -u 33 nextcloud-app php occ config:app:set bruteforcesettings whitelist --value='["192.168.88.1/24"]'

- name: 13. Trust Step-CA Root Certificate (When available)
  shell: |
    # The Step-CA root certificate will be injected via Docker Volume /usr/local/share/ca-certificates/
    # This command tells the Nextcloud OS to trust any newly mounted CA certificates.
    docker exec -u 0 nextcloud-app update-ca-certificates

- name: 14. Finalize Secure Web Server State
  shell: |
    docker exec -u 0 nextcloud-app a2enmod ssl
    docker exec -u 0 nextcloud-app a2ensite default-ssl
    docker restart nextcloud-app
  ignore_errors: yes
