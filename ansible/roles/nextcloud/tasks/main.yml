---
- name: 2. Create Nextcloud Directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - /opt/nextcloud
    - /var/lib/nextcloud/certs
    - /var/lib/nextcloud/ca-certificates

- name: 2b. Set Nextcloud Certificate Directory Permissions
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "33"
    group: "33"
    mode: "0755"
  loop:
    - /var/lib/nextcloud/certs
    - /var/lib/nextcloud/ca-certificates

# ---------------------------------------------------------
# STEP-CA INTEGRATION
# ---------------------------------------------------------
- name: Check if Nextcloud certificate already exists
  ansible.builtin.stat:
    path: /var/lib/nextcloud/certs/tls.crt
  register: nextcloud_cert_stat

- name: Generate Nextcloud Certificate on CA (Delegate)
  ansible.builtin.shell: |
    step ca certificate cloud.server.acme \
      /tmp/cloud_server_acme.crt \
      /tmp/cloud_server_acme.key \
      --ca-url https://auth.server.acme:9000 \
      --root /etc/step-ca/certs/root_ca.crt \
      --not-after=87600h \
      --password-file /etc/step-ca/password.txt
  delegate_to: auth.server.acme
  when: not nextcloud_cert_stat.stat.exists
  changed_when: true

- name: Read generated certificate from CA
  ansible.builtin.slurp:
    src: /tmp/cloud_server_acme.crt
  delegate_to: auth.server.acme
  register: slurp_nextcloud_cert
  when: not nextcloud_cert_stat.stat.exists

- name: Read generated key from CA
  ansible.builtin.slurp:
    src: /tmp/cloud_server_acme.key
  delegate_to: auth.server.acme
  register: slurp_nextcloud_key
  when: not nextcloud_cert_stat.stat.exists

- name: Read Step CA root certificate
  ansible.builtin.slurp:
    src: /etc/step-ca/certs/root_ca.crt
  delegate_to: auth.server.acme
  register: slurp_stepca_root
  when: not nextcloud_cert_stat.stat.exists

- name: Clean up temporary files on CA
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  delegate_to: auth.server.acme
  loop:
    - /tmp/cloud_server_acme.crt
    - /tmp/cloud_server_acme.key
  when: not nextcloud_cert_stat.stat.exists

- name: Write Nextcloud certificate to destination
  ansible.builtin.copy:
    content: "{{ slurp_nextcloud_cert['content'] | b64decode }}"
    dest: /var/lib/nextcloud/certs/tls.crt
    owner: "33"
    group: "33"
    mode: "0644"
  when: not nextcloud_cert_stat.stat.exists

- name: Write Nextcloud key to destination
  ansible.builtin.copy:
    content: "{{ slurp_nextcloud_key['content'] | b64decode }}"
    dest: /var/lib/nextcloud/certs/tls.key
    owner: "33"
    group: "33"
    mode: "0600"
  when: not nextcloud_cert_stat.stat.exists

- name: Write Step CA root certificate to destination
  ansible.builtin.copy:
    content: "{{ slurp_stepca_root['content'] | b64decode }}"
    dest: /var/lib/nextcloud/ca-certificates/step-ca.crt
    owner: "33"
    group: "33"
    mode: "0644"
  when: not nextcloud_cert_stat.stat.exists
# ---------------------------------------------------------

- name: 3. Copy Docker Compose to VM
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: /opt/nextcloud/docker-compose.yml
    mode: "0644"

- name: 4. Run Nextcloud Stack
  ansible.builtin.command:
    cmd: docker compose -f /opt/nextcloud/docker-compose.yml up -d
  changed_when: false

- name: 5. Wait for Nextcloud container to be ready
  ansible.builtin.pause:
    seconds: 10

- name: 6. Check if Nextcloud is already installed
  ansible.builtin.command:
    cmd: docker exec -u 33 nextcloud-app php occ status --output=json
  register: nextcloud_status
  failed_when: false
  changed_when: false

- name: 7. Run Nextcloud basic installation
  ansible.builtin.shell: |
    docker exec -u 33 nextcloud-app php occ maintenance:install \
      --database "mysql" --database-name "nextcloud" \
      --database-user "nextcloud" \
      --database-pass "{{ vault_nextcloud_db_password }}" \
      --database-host "db" \
      --admin-user "admin" \
      --admin-pass "{{ vault_nextcloud_admin_password }}"
  when: >-
    not ((nextcloud_status.stdout | default('{}') | from_json).installed |
    default(false))
  register: nextcloud_occ_install
  until: nextcloud_occ_install.rc == 0
  retries: 10
  delay: 5
  changed_when: true

- name: 8. Install and Enable Nextcloud Talk (spreed)
  ansible.builtin.shell: |
    docker exec -u 33 nextcloud-app php occ app:install spreed
  register: nextcloud_spreed_install
  failed_when:
    - nextcloud_spreed_install.rc != 0
    - '"already installed" not in nextcloud_spreed_install.stdout'
  changed_when: '"already installed" not in nextcloud_spreed_install.stdout'

- name: 10. Hardcode ACME Trusted Domains and Setup Network Security
  ansible.builtin.shell: |
    OCC="docker exec -u 33 nextcloud-app php occ"
    $OCC config:system:set trusted_domains 0 --value="localhost"
    $OCC config:system:set trusted_domains 1 --value="cloud.server.acme"

    # Configure trusted proxies for gateway passing
    $OCC config:system:set trusted_proxies 0 --value="10.0.50.0/24"
    $OCC config:system:set trusted_proxies 1 --value="10.0.10.0/24"
    $OCC config:system:set trusted_proxies 2 --value="10.0.20.0/24"
    $OCC config:system:set trusted_proxies 3 --value="10.0.11.0/24"

    $OCC config:system:set overwriteprotocol --value="https"
    $OCC config:system:delete overwritehost
  failed_when: false
  changed_when: false

- name: 11. Install and Enable OIDC App
  ansible.builtin.shell: |
    docker exec -u 33 nextcloud-app php occ app:install user_oidc
    docker exec -u 33 nextcloud-app php occ app:enable user_oidc
  register: nextcloud_oidc_install
  failed_when:
    - nextcloud_oidc_install.rc != 0
    - '"already installed" not in nextcloud_oidc_install.stdout'
  changed_when: '"already installed" not in nextcloud_oidc_install.stdout'

- name: 12. Final OIDC Configuration
  ansible.builtin.shell: |
    OCC="docker exec -u 33 nextcloud-app php occ"
    URI="https://auth.server.acme:8443/realms/acme-realm/.well-known/openid-configuration"

    $OCC config:system:set allow_local_remote_servers \
      --value=true --type=boolean
    $OCC user_oidc:provider "Keycloak" \
      --clientid "nextcloud-client" \
      --clientsecret "{{ vault_nextcloud_oidc_secret }}" \
      --discoveryuri "$URI" \
      --scope "openid profile email"

    $OCC config:system:set oidc_login_auto_redirect \
      --value=true --type=boolean
    $OCC config:app:set user_oidc allow_multiple_user_backends --value=0
    $OCC config:app:set user_oidc soft_auto_provision --value=1

    WL='["10.0.50.0/24", "10.0.10.0/24", "10.0.20.0/24", "10.0.11.0/24"]'
    $OCC config:app:set bruteforcesettings whitelist --value="$WL"
  changed_when: false

- name: 13. Trust Step-CA Root Certificate (When available)
  ansible.builtin.shell: |
    # The Step-CA root certificate will be injected via Docker Volume
    # /usr/local/share/ca-certificates/
    # This command tells the Nextcloud OS to trust any newly mounted
    # CA certificates.
    docker exec -u 0 nextcloud-app update-ca-certificates
  changed_when: false

- name: 14. Finalize Secure Web Server State
  ansible.builtin.shell: |
    docker exec -u 0 nextcloud-app a2enmod ssl
    docker exec -u 0 nextcloud-app a2ensite default-ssl
    docker restart nextcloud-app
  failed_when: false
  changed_when: false
