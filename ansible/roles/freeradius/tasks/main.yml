---
- name: Install FreeRADIUS packages
  apt:
    name:
      - freeradius
      - freeradius-utils
    state: present
    update_cache: yes

- name: Ensure FreeRADIUS service is enabled and started
  service:
    name: freeradius
    state: started
    enabled: yes
- name: Ensure FreeRADIUS cert directory exists
  file:
    path: /etc/freeradius/certs
    state: directory
    owner: freerad
    group: freerad
    mode: '0750'

- name: Wait for Step CA to be reachable
  uri:
    url: https://ca.server.acme:9000/health
    method: GET
    validate_certs: no
  register: ca_health
  retries: 10
  delay: 3
  until: ca_health.status == 200

- name: Get CA root fingerprint
  command: step certificate fingerprint /etc/step-ca/certs/root_ca.crt
  register: ca_fingerprint
  changed_when: false

- name: Bootstrap step CLI for root
  command: >
    step ca bootstrap
    --ca-url https://ca.server.acme:9000
    --fingerprint {{ ca_fingerprint.stdout }}
  args:
    creates: /root/.step/config/defaults.json

- name: Remove old RADIUS certificate if present
  file:
    path: /etc/freeradius/certs/radius.crt
    state: absent

- name: Remove old RADIUS key if present
  file:
    path: /etc/freeradius/certs/radius.key
    state: absent

- name: Generate RADIUS certificate
  shell: |
    step ca certificate radius.server.acme \
      /etc/freeradius/certs/radius.crt \
      /etc/freeradius/certs/radius.key \
      --ca-url https://ca.server.acme:9000 \
      --root /etc/step-ca/certs/root_ca.crt \
      --password-file /etc/step-ca/password.txt
  args:
    creates: /etc/freeradius/certs/radius.crt
  notify: Restart FreeRADIUS

- name: Copy Root CA certificate
  copy:
    src: /etc/step-ca/certs/root_ca.crt
    dest: /etc/freeradius/certs/root_ca.crt
    remote_src: yes
    owner: freerad
    group: freerad
    mode: '0640'

- name: Fix ownership of RADIUS certificates
  file:
    path: /etc/freeradius/certs
    owner: freerad
    group: freerad
    recurse: yes

- name: Add router client definitions to clients.conf
  blockinfile:
    path: /etc/freeradius/3.0/clients.conf
    marker: "# {mark} ANSIBLE MANAGED ROUTERS"
    block: |
      client london-router {
          ipaddr = 10.10.0.1
          secret = hacme123
          require_message_authenticator = no
      }

      client stockholm-router {
          ipaddr = 10.20.0.1
          secret = hacme123
          require_message_authenticator = no
      }
  notify: Restart FreeRADIUS
