# USB-C Ethernet adapter name as shown by: VBoxManage list bridgedifs | grep "^Name:"
# export BRIDGE_ADAPTER="en6: USB 10/100/1000 LAN" (add to .envrc)
BRIDGE_ADAPTER = ENV.fetch("BRIDGE_ADAPTER") { abort "Set BRIDGE_ADAPTER env var (run: VBoxManage list bridgedifs)" }

MACHINES = {
  "dns.server.acme" => {
    ip: "10.0.50.10",
    memory: 1024,
    cpus: 1,
    cloud_init: <<~YAML,
      package_update: true
      packages:
        - unbound
    YAML
  },
  "vpn.server.acme" => {
    ip: "10.0.50.11",
    memory: 1024,
    cpus: 1,
    cloud_init: <<~YAML,
      package_update: true
      packages:
        - wireguard
        - iptables
    YAML
  },
  "cloud.server.acme" => {
    ip: "10.0.50.12",
    memory: 2048,
    cpus: 2,
    cloud_init: <<~YAML,
      package_update: true
      packages:
        - nginx
    YAML
  },
  "dvwa.server.acme" => {
    ip: "10.0.50.50",
    memory: 1024,
    cpus: 1,
    cloud_init: <<~YAML,
      package_update: true
    YAML
  },
}

Vagrant.configure("2") do |config|
  config.vm.box = "cloud-image/debian-13"
  # https://portal.cloud.hashicorp.com/vagrant/discover/cloud-image/debian-13
  config.vm.box_version = "20260210.2384.0"

  # Disable synced folder
  config.vm.synced_folder ".", "/vagrant", disabled: true

  # Keep the insecure key so Ansible can use a single key for all VMs
  config.ssh.insert_key = false

  MACHINES.each do |name, opts|
    config.vm.define name do |node|
      node.vm.hostname = name

      # Bridge directly Ethernet adapter.
      # Each VM appears as its own device on the 10.0.50.0/24 network.
      node.vm.network "public_network",
        bridge: BRIDGE_ADAPTER,
        ip: opts[:ip],
        netmask: "255.255.255.0"

      # Per-VM cloud-init with network configuration
      node.vm.cloud_init do |cloud_init|
        cloud_init.content_type = "text/cloud-config"
        
        # Build cloud-config with network setup
        cloud_config = {
          "hostname" => name,
          "write_files" => [
            {
              "path" => "/etc/systemd/network/10-enp0s9.network",
              "content" => <<~NETWORK.chomp,
                [Match]
                Name=enp0s9

                [Network]
                DHCP=no
                Address=#{opts[:ip]}/24
                Gateway=10.0.50.1
                DNS=10.0.50.10
                RouteMetric=10

                [Route]
                Gateway=10.0.50.1
                Metric=10
              NETWORK
              "permissions" => "0644"
            },
            {
              "path" => "/etc/systemd/network/20-enp0s8.network",
              "content" => <<~NETWORK.chomp,
                [Match]
                Name=enp0s8

                [Network]
                DHCP=yes
                RouteMetric=200

                [DHCP]
                UseRoutes=yes
                UseDNS=no

                [DHCPv4]
                RouteMetric=200
              NETWORK
              "permissions" => "0644"
            }
          ],
          "runcmd" => [
            "systemctl enable systemd-networkd",
            "systemctl restart systemd-networkd"
          ]
        }

        # Merge per-VM packages if specified
        if opts[:cloud_init]
          require 'yaml'
          vm_config = YAML.load(opts[:cloud_init])
          cloud_config.merge!(vm_config)
        end

        cloud_init.inline = cloud_config.to_yaml
      end

      node.vm.provider :virtualbox do |vb|
        vb.name = "acme-#{name}"
        vb.memory = opts[:memory]
        vb.cpus = opts[:cpus]
      end
    end
  end
end
